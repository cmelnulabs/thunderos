name: ThunderOS CI

on:
  push:
    branches: [ main, 'dev/**', 'feature/**', 'release/**' ]
  pull_request:
    branches: [ main, 'dev/**' ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install RISC-V toolchain
      run: |
        sudo apt-get update
        # Install specific version to match local environment
        sudo apt-get install -y gcc-riscv64-unknown-elf=10.2.0* binutils-riscv64-unknown-elf || \
        sudo apt-get install -y gcc-riscv64-unknown-elf binutils-riscv64-unknown-elf
        # Show installed version for debugging
        riscv64-unknown-elf-gcc --version | head -1
    
    - name: Install QEMU
      run: |
        sudo apt-get install -y qemu-system-misc
    
    - name: Verify toolchain installation
      run: |
        riscv64-unknown-elf-gcc --version
        qemu-system-riscv64 --version
    
    - name: Clean build environment
      run: make clean || true
    
    - name: Build kernel
      run: make
    
    - name: Verify build artifacts
      run: |
        test -f build/thunderos.elf || (echo "thunderos.elf not found" && exit 1)
        test -f build/thunderos.bin || (echo "thunderos.bin not found" && exit 1)
        ls -lh build/thunderos.*
    
    - name: Run QEMU boot test
      run: |
        # Run QEMU in background and capture output
        make qemu > qemu_output.log 2>&1 &
        QEMU_PID=$!
        
        # Wait for QEMU to start and produce output (8 seconds for full initialization)
        sleep 8
        
        # Kill QEMU process and all its children
        kill -TERM $QEMU_PID 2>/dev/null || true
        sleep 1
        kill -KILL $QEMU_PID 2>/dev/null || true
        wait $QEMU_PID 2>/dev/null || true
        
        # Display output for debugging
        echo "=== QEMU Output ==="
        cat qemu_output.log
        echo "=== End Output ==="
        
        # Check for boot loop (multiple initializations indicate crash/reboot)
        BOOT_COUNT=$(grep -c "^Initializing\.\.\.$" qemu_output.log || echo 0)
        if [ "$BOOT_COUNT" -gt 2 ]; then
          echo "ERROR: Kernel is stuck in a boot loop (rebooted $BOOT_COUNT times)"
          echo "This indicates a crash after initialization"
          exit 1
        fi
        
        # Verify boot messages
        if ! grep -q "ThunderOS\|Kernel" qemu_output.log; then
          echo "ERROR: Boot messages not found"
          exit 1
        fi
        
        # Check for successful initialization (PMM, Paging, or Process messages)
        if ! grep -q "Process\|PMM\|Paging\|Scheduler\|Multitasking" qemu_output.log; then
          echo "ERROR: Kernel initialization incomplete or process scheduling not working"
          exit 1
        fi
        
        echo "✓ Boot test passed"
    
    - name: Build tests
      run: |
        cd tests
        make || echo "⚠ Test build skipped (optional)"
    
    - name: Run unit tests
      continue-on-error: true
      run: |
        cd tests
        if [ -f test_paging ]; then
          timeout 10s qemu-system-riscv64 -machine virt -m 128M -nographic -serial mon:stdio -bios default -kernel test_paging > test_output.log 2>&1 &
          TEST_PID=$!
          sleep 3
          kill $TEST_PID 2>/dev/null || true
          wait $TEST_PID 2>/dev/null || true
          cat test_output.log
        fi
    
    - name: Check for build warnings
      run: |
        make clean
        make 2>&1 | tee build_warnings.log
        if grep -i "warning:" build_warnings.log; then
          echo "⚠ Build produced warnings (non-fatal)"
        else
          echo "✓ Clean build with no warnings"
        fi
    
    - name: Upload build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: thunderos-build-${{ github.sha }}
        path: |
          build/thunderos.elf
          build/thunderos.bin
        retention-days: 7
    
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-${{ github.sha }}
        path: |
          qemu_output.log
          build_warnings.log
          tests/test_output.log
        retention-days: 7
    
    - name: Report success
      if: success()
      run: |
        echo "✅ All checks passed!"
        echo "Kernel built successfully and boots correctly in QEMU"
